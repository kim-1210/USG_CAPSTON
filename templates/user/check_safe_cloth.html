<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Streaming</title>
    <style>
        body {
            width: 100%;
            height: 100%;
            border: 0;
            padding: 0;
        }

        div.header {
            background-color: aqua;
        }

        div.middle {
            background-color: antiquewhite;
            position: relative;
            width: 50%;
            height: 50%;
        }

        div.bottom {
            background-color: burlywood;
        }

        video.camera {
            width: 40%;
            height: 60%;
            display: none;
        }

        img.result-image {
            width: 100%;
            height: auto;
        }

        div.bounding-box {
            position: absolute;
            border: 2px solid red;
            display: none;
        }
    </style>
</head>

<body>
    <div class="header"></div>
    <div class="middle">
        <video id="video" class="camera" autoplay ></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <img id="resultImage" class="result-image" src="" alt="Result Image">
        <div id="boundingBox" class="bounding-box">
        </div>
    </div>
    <div class="bottom"></div>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            }
            catch (error) {
                alert("카메라가 없습니다.")
            }
        }

        startCamera();

        // 이미지 전송 함수
        function sendImageToServer(imageData) {
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/process_image", true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    // 서버에서의 응답 처리
                    var responseData = JSON.parse(xhr.responseText);
                    var resultImage = document.getElementById('resultImage');
                    resultImage.src = 'data:image/jpeg;base64,' + responseData.result_image;

                    // 바운딩 박스 표시
                    var boundingBox = document.getElementById('boundingBox');
                    var boundingBoxInfo = responseData.bounding_box;
                    boundingBox.style.left = boundingBoxInfo[0] + 'px';
                    boundingBox.style.top = boundingBoxInfo[1] + 'px';
                    boundingBox.style.width = (boundingBoxInfo[2] - boundingBoxInfo[0]) + 'px';
                    boundingBox.style.height = (boundingBoxInfo[3] - boundingBoxInfo[1]) + 'px';
                }
            };

            // 이미지 데이터를 JSON 형태로 변환하여 전송
            xhr.send(JSON.stringify({ image_data: imageData }));
        }

        // 프레임 캡처 및 이미지 전송
        function captureFrame() {
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg', 0.7);  // 이미지 데이터를 base64로 변환
            sendImageToServer(imageData);
        }

        // 프레임 캡처 주기 설정 (예: 1초에 한 번)
        setInterval(captureFrame, 500);
    </script>
</body>

</html>
